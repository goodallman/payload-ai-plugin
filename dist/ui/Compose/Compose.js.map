{"version":3,"sources":["../../../src/ui/Compose/Compose.tsx"],"sourcesContent":["'use client'\r\n\r\nimport type { ClientField } from 'payload'\r\nimport type { FC } from 'react'\r\n\r\nimport { useEditorConfigContext } from '@payloadcms/richtext-lexical/client'\r\nimport { FieldDescription, Popup, useDocumentDrawer, useField } from '@payloadcms/ui'\r\nimport React, { useCallback, useEffect, useMemo, useRef, useState } from 'react'\r\n\r\nimport { PLUGIN_INSTRUCTIONS_TABLE } from '../../defaults.js'\r\nimport { setSafeLexicalState } from '../../utilities/setSafeLexicalState.js'\r\nimport { PluginIcon } from '../Icons/Icons.js'\r\nimport { UndoRedoActions } from './UndoRedoActions.js'\r\nimport styles from './compose.module.css'\r\nimport { useMenu } from './hooks/menu/useMenu.js'\r\nimport { useGenerate } from './hooks/useGenerate.js'\r\n\r\nfunction findParentWithClass(element, className) {\r\n  // Base case: if the element is null or we've reached the top of the DOM\r\n  if (!element || element === document.body) {\r\n    return null\r\n  }\r\n\r\n  // Check if the current element has the class we're looking for\r\n  if (element.classList.contains(className)) {\r\n    return element\r\n  }\r\n\r\n  // Recursively call the function on the parent element\r\n  return findParentWithClass(element.parentElement, className)\r\n}\r\n\r\ntype ComposeProps = {\r\n  descriptionProps?: {\r\n    field: ClientField\r\n    path: string\r\n    schemaPath: string\r\n  }\r\n  instructionId: string\r\n  isConfigAllowed: boolean\r\n}\r\n\r\nexport const Compose: FC<ComposeProps> = ({ descriptionProps, instructionId, isConfigAllowed }) => {\r\n  const [DocumentDrawer, _, { closeDrawer, openDrawer }] = useDocumentDrawer({\r\n    id: instructionId,\r\n    collectionSlug: PLUGIN_INSTRUCTIONS_TABLE,\r\n  })\r\n\r\n  const {\r\n    field: { type: fieldType },\r\n    path: pathFromContext,\r\n    schemaPath,\r\n  } = descriptionProps || {}\r\n  const { editor: lexicalEditor, editorContainerRef } = useEditorConfigContext()\r\n\r\n  // Below snippet is used to show/hide the actions menu on AI enabled fields\r\n  const [input, setInput] = useState(null)\r\n  const actionsRef = useRef(null)\r\n\r\n  // Set input element for current field\r\n  useEffect(() => {\r\n    if (!actionsRef.current) return\r\n\r\n    const fieldId = `field-${pathFromContext.replace(/\\./g, '__')}`\r\n    const inputElement = document.getElementById(fieldId)\r\n\r\n    if (!inputElement && fieldType === 'richText') {\r\n      setInput(editorContainerRef.current)\r\n    } else {\r\n      actionsRef.current.setAttribute('for', fieldId)\r\n      setInput(inputElement)\r\n    }\r\n  }, [pathFromContext, schemaPath, actionsRef, editorContainerRef])\r\n\r\n  // Show or hide actions menu on field\r\n  useEffect(() => {\r\n    if (!input || !actionsRef.current) return\r\n\r\n    actionsRef.current.classList.add(styles.actions_hidden)\r\n\r\n    // Create the handler function\r\n    const clickHandler = (event) => {\r\n      document.querySelectorAll('.ai-plugin-active')?.forEach((element) => {\r\n        const actionElement = element.querySelector(`.${styles.actions}`)\r\n        if (actionElement) {\r\n          actionElement.classList.add(styles.actions_hidden)\r\n          element.classList.remove('ai-plugin-active')\r\n        }\r\n      })\r\n\r\n      actionsRef.current.classList.remove(styles.actions_hidden)\r\n      const parentWithClass = findParentWithClass(event.target, 'field-type')\r\n      if (parentWithClass) {\r\n        parentWithClass.classList.add('ai-plugin-active')\r\n      }\r\n    }\r\n\r\n    // Add the event listener\r\n    input.addEventListener('click', clickHandler)\r\n\r\n    // Clean up the event listener when the component unmounts or input changes\r\n    return () => {\r\n      input.removeEventListener('click', clickHandler)\r\n    }\r\n  }, [input, actionsRef])\r\n\r\n  const [isProcessing, setIsProcessing] = useState(false)\r\n  const { generate, isLoading, stop } = useGenerate({ instructionId })\r\n\r\n  const { ActiveComponent, Menu } = useMenu({\r\n    onCompose: async () => {\r\n      console.log('Composing...')\r\n      setIsProcessing(true)\r\n      await generate({\r\n        action: 'Compose',\r\n      }).finally(() => {\r\n        setIsProcessing(false)\r\n      })\r\n    },\r\n    onExpand: async () => {\r\n      console.log('Expanding...')\r\n      await generate({\r\n        action: 'Expand',\r\n      })\r\n    },\r\n    onProofread: async () => {\r\n      console.log('Proofreading...')\r\n      await generate({\r\n        action: 'Proofread',\r\n      })\r\n    },\r\n    onRephrase: async () => {\r\n      console.log('Rephrasing...')\r\n      await generate({\r\n        action: 'Rephrase',\r\n      })\r\n    },\r\n    onSettings: isConfigAllowed ? openDrawer : undefined,\r\n    onSimplify: async () => {\r\n      console.log('Simplifying...')\r\n      await generate({\r\n        action: 'Simplify',\r\n      })\r\n    },\r\n    onSummarize: async () => {\r\n      console.log('Summarizing...')\r\n      await generate({\r\n        action: 'Summarize',\r\n      })\r\n    },\r\n    onTranslate: async (data) => {\r\n      console.log('Translating...')\r\n      console.log(data)\r\n      await generate({\r\n        action: 'Translate',\r\n        params: data,\r\n      })\r\n    },\r\n  },{\r\n    isConfigAllowed\r\n  })\r\n\r\n  const { setValue } = useField<string>({\r\n    path: pathFromContext,\r\n  })\r\n\r\n  const setIfValueIsLexicalState = useCallback((val: any) => {\r\n    if (val.root && lexicalEditor) {\r\n      setSafeLexicalState(JSON.stringify(val), lexicalEditor)\r\n    }\r\n\r\n    // DO NOT PROVIDE lexicalEditor as a dependency, it freaks out and does not update the editor after first undo/redo\r\n  }, [])\r\n\r\n  const popupRender = useCallback(\r\n    ({ close }) => {\r\n      return <Menu isLoading={isProcessing || isLoading} onClose={close} />\r\n    },\r\n    [isProcessing, isLoading, Menu],\r\n  )\r\n\r\n  const memoizedPopup = useMemo(() => {\r\n    return (\r\n      <Popup\r\n        button={<PluginIcon isLoading={isProcessing || isLoading} />}\r\n        render={popupRender}\r\n        verticalAlign=\"bottom\"\r\n      />\r\n    )\r\n  }, [popupRender, isProcessing, isLoading])\r\n\r\n  return (\r\n    <React.Fragment>\r\n      <label\r\n        className={`${styles.actions}`}\r\n        onClick={(e) => e.preventDefault()}\r\n        ref={actionsRef}\r\n        role=\"presentation\"\r\n      >\r\n        <DocumentDrawer\r\n          onSave={() => {\r\n            closeDrawer()\r\n          }}\r\n        />\r\n        {memoizedPopup}\r\n        <ActiveComponent isLoading={isProcessing || isLoading} stop={stop} />\r\n        <UndoRedoActions\r\n          onChange={(val) => {\r\n            setValue(val)\r\n            setIfValueIsLexicalState(val)\r\n          }}\r\n        />\r\n      </label>\r\n      {/*Render incoming description field*/}\r\n      {descriptionProps ? (\r\n        <div>\r\n          <FieldDescription {...descriptionProps} />\r\n        </div>\r\n      ) : null}\r\n    </React.Fragment>\r\n  )\r\n}\r\n"],"names":["useEditorConfigContext","FieldDescription","Popup","useDocumentDrawer","useField","React","useCallback","useEffect","useMemo","useRef","useState","PLUGIN_INSTRUCTIONS_TABLE","setSafeLexicalState","PluginIcon","UndoRedoActions","styles","useMenu","useGenerate","findParentWithClass","element","className","document","body","classList","contains","parentElement","Compose","descriptionProps","instructionId","isConfigAllowed","DocumentDrawer","_","closeDrawer","openDrawer","id","collectionSlug","field","type","fieldType","path","pathFromContext","schemaPath","editor","lexicalEditor","editorContainerRef","input","setInput","actionsRef","current","fieldId","replace","inputElement","getElementById","setAttribute","add","actions_hidden","clickHandler","event","querySelectorAll","forEach","actionElement","querySelector","actions","remove","parentWithClass","target","addEventListener","removeEventListener","isProcessing","setIsProcessing","generate","isLoading","stop","ActiveComponent","Menu","onCompose","console","log","action","finally","onExpand","onProofread","onRephrase","onSettings","undefined","onSimplify","onSummarize","onTranslate","data","params","setValue","setIfValueIsLexicalState","val","root","JSON","stringify","popupRender","close","onClose","memoizedPopup","button","render","verticalAlign","Fragment","label","onClick","e","preventDefault","ref","role","onSave","onChange","div"],"mappings":"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"}