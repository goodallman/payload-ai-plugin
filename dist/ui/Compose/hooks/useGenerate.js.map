{"version":3,"sources":["../../../../src/ui/Compose/hooks/useGenerate.ts"],"sourcesContent":["import { useEditorConfigContext } from '@payloadcms/richtext-lexical/client'\r\nimport { useConfig, useField, useForm, useLocale } from '@payloadcms/ui'\r\nimport { jsonSchema } from 'ai'\r\nimport { useCompletion, experimental_useObject as useObject } from 'ai/react'\r\nimport { useCallback, useEffect, useMemo, useRef } from 'react'\r\n\r\nimport type { ActionMenuItems, GenerateTextarea } from '../../../types.js'\r\n\r\nimport {\r\n  PLUGIN_API_ENDPOINT_GENERATE,\r\n  PLUGIN_API_ENDPOINT_GENERATE_UPLOAD,\r\n  PLUGIN_INSTRUCTIONS_TABLE,\r\n  PLUGIN_NAME,\r\n} from '../../../defaults.js'\r\nimport { useFieldProps } from '../../../providers/FieldProvider/useFieldProps.js'\r\nimport { editorSchemaValidator } from '../../../utilities/editorSchemaValidator.js'\r\nimport { setSafeLexicalState } from '../../../utilities/setSafeLexicalState.js'\r\nimport { useHistory } from './useHistory.js'\r\n\r\ntype ActionCallbackParams = { action: ActionMenuItems; params?: unknown }\r\n\r\nexport const useGenerate = ({ instructionId }: { instructionId: string }) => {\r\n  // Create a ref to hold the current instructionId\r\n  const instructionIdRef = useRef(instructionId)\r\n\r\n  // Update the ref whenever instructionId changes\r\n  useEffect(() => {\r\n    instructionIdRef.current = instructionId\r\n  }, [instructionId])\r\n\r\n  const { type, path: pathFromContext } = useFieldProps()\r\n  const editorConfigContext = useEditorConfigContext()\r\n\r\n  const { editor } = editorConfigContext\r\n\r\n  const { config } = useConfig()\r\n  const {\r\n    routes: { api },\r\n    serverURL,\r\n  } = config\r\n\r\n  const { setValue } = useField<string>({\r\n    path: pathFromContext,\r\n  })\r\n\r\n  const { set: setHistory } = useHistory()\r\n\r\n  const { getData } = useForm()\r\n  const localFromContext = useLocale()\r\n  const {\r\n    config: { collections },\r\n  } = useConfig()\r\n\r\n  const collection = collections.find((collection) => collection.slug === PLUGIN_INSTRUCTIONS_TABLE)\r\n  const { custom: { [PLUGIN_NAME]: { editorConfig = {} } = {} } = {} } = collection.admin\r\n  const { schema: editorSchema = {} } = editorConfig\r\n\r\n  const memoizedValidator = useMemo(() => {\r\n    return editorSchemaValidator(editorSchema)\r\n  }, [editorSchema])\r\n\r\n  const memoizedSchema = useMemo(\r\n    () =>\r\n      jsonSchema(editorSchema, {\r\n        validate: (value) => {\r\n          const isValid = memoizedValidator(value)\r\n\r\n          if (isValid) {\r\n            return {\r\n              success: true,\r\n              value,\r\n            }\r\n          } else {\r\n            return {\r\n              error: new Error('Invalid schema'),\r\n              success: false,\r\n            }\r\n          }\r\n        },\r\n      }),\r\n    [memoizedValidator],\r\n  )\r\n\r\n  const {\r\n    isLoading: loadingObject,\r\n    object,\r\n    stop: objectStop,\r\n    submit,\r\n  } = useObject({\r\n    api: `/api${PLUGIN_API_ENDPOINT_GENERATE}`,\r\n    onError: (error) => {\r\n      console.error('Error generating object:', error)\r\n    },\r\n    onFinish: (result) => {\r\n      if (result.object) {\r\n        setHistory(result.object)\r\n        setValue(result.object)\r\n      } else {\r\n        console.log('onFinish: result ', result)\r\n      }\r\n    },\r\n    schema: memoizedSchema,\r\n  })\r\n\r\n  useEffect(() => {\r\n    if (!object) return\r\n\r\n    requestAnimationFrame(() => {\r\n      const validateObject = memoizedSchema.validate(object)\r\n      if (validateObject?.success) {\r\n        setSafeLexicalState(object, editor)\r\n      }\r\n    })\r\n  }, [object, editor])\r\n\r\n  const {\r\n    complete,\r\n    completion,\r\n    isLoading: loadingCompletion,\r\n    stop: completionStop,\r\n  } = useCompletion({\r\n    api: `${serverURL}${api}${PLUGIN_API_ENDPOINT_GENERATE}`,\r\n    onError: (error) => {\r\n      console.error('Error generating text:', error)\r\n    },\r\n    onFinish: (prompt, result) => {\r\n      setHistory(result)\r\n    },\r\n    streamProtocol: 'data',\r\n  })\r\n\r\n  useEffect(() => {\r\n    if (!completion) return\r\n\r\n    requestAnimationFrame(() => {\r\n      setValue(completion)\r\n    })\r\n  }, [completion])\r\n\r\n  const streamObject = useCallback(\r\n    ({ action = 'Compose', params }: ActionCallbackParams) => {\r\n      const doc = getData()\r\n\r\n      const currentInstructionId = instructionIdRef.current\r\n\r\n      const options = {\r\n        action,\r\n        actionParams: params,\r\n        instructionId: currentInstructionId,\r\n      }\r\n\r\n      submit({\r\n        doc,\r\n        locale: localFromContext?.code,\r\n        options,\r\n      })\r\n    },\r\n    [localFromContext?.code, instructionIdRef],\r\n  )\r\n\r\n  const streamText = useCallback(\r\n    async ({ action = 'Compose', params }: ActionCallbackParams) => {\r\n      const doc = getData()\r\n      const currentInstructionId = instructionIdRef.current\r\n\r\n      const options = {\r\n        action,\r\n        actionParams: params,\r\n        instructionId: currentInstructionId,\r\n      }\r\n\r\n      await complete('', {\r\n        body: {\r\n          doc,\r\n          locale: localFromContext?.code,\r\n          options,\r\n        },\r\n      })\r\n    },\r\n    [getData, localFromContext?.code, instructionIdRef, complete],\r\n  )\r\n\r\n  const generateUpload = useCallback(async () => {\r\n    const doc = getData()\r\n    const currentInstructionId = instructionIdRef.current\r\n\r\n    return fetch(`${serverURL}${api}${PLUGIN_API_ENDPOINT_GENERATE_UPLOAD}`, {\r\n      body: JSON.stringify({\r\n        doc,\r\n        locale: localFromContext?.code,\r\n        options: {\r\n          instructionId: currentInstructionId,\r\n        },\r\n      } satisfies Parameters<GenerateTextarea>[0]),\r\n      credentials: 'include',\r\n      headers: {\r\n        'Content-Type': 'application/json',\r\n      },\r\n      method: 'POST',\r\n    })\r\n      .then(async (uploadResponse) => {\r\n        if (uploadResponse.ok) {\r\n          const { result } = await uploadResponse.json()\r\n          if (!result) throw new Error('generateUpload: Something went wrong')\r\n\r\n          setValue(result?.id)\r\n          setHistory(result?.id)\r\n          console.log('Image updated...', result)\r\n        } else {\r\n          const { errors = [] } = await uploadResponse.json()\r\n          const errStr = errors.map((error) => error.message).join(', ')\r\n          throw new Error(errStr)\r\n        }\r\n        return uploadResponse\r\n      })\r\n      .catch((error) => {\r\n        console.error(\r\n          'Error generating or setting your upload, please set it manually if its saved in your media files: ',\r\n          error,\r\n        )\r\n      })\r\n  }, [getData, localFromContext?.code, instructionIdRef, setValue])\r\n\r\n  const generate = useCallback(\r\n    async (options?: ActionCallbackParams) => {\r\n      if (type === 'richText') {\r\n        return streamObject(options)\r\n      }\r\n\r\n      if (['text', 'textarea'].includes(type)) {\r\n        return streamText(options)\r\n      }\r\n\r\n      if (type === 'upload') {\r\n        return generateUpload()\r\n      }\r\n    },\r\n    [generateUpload, streamObject, streamText, type],\r\n  )\r\n\r\n  const stop = useCallback(() => {\r\n    console.log('Stopping...')\r\n    objectStop()\r\n    completionStop()\r\n  }, [objectStop, completionStop])\r\n\r\n  return {\r\n    generate,\r\n    isLoading: loadingCompletion || loadingObject,\r\n    stop,\r\n  }\r\n}\r\n"],"names":["useEditorConfigContext","useConfig","useField","useForm","useLocale","jsonSchema","useCompletion","experimental_useObject","useObject","useCallback","useEffect","useMemo","useRef","PLUGIN_API_ENDPOINT_GENERATE","PLUGIN_API_ENDPOINT_GENERATE_UPLOAD","PLUGIN_INSTRUCTIONS_TABLE","PLUGIN_NAME","useFieldProps","editorSchemaValidator","setSafeLexicalState","useHistory","useGenerate","instructionId","instructionIdRef","current","type","path","pathFromContext","editorConfigContext","editor","config","routes","api","serverURL","setValue","set","setHistory","getData","localFromContext","collections","collection","find","slug","custom","editorConfig","admin","schema","editorSchema","memoizedValidator","memoizedSchema","validate","value","isValid","success","error","Error","isLoading","loadingObject","object","stop","objectStop","submit","onError","console","onFinish","result","log","requestAnimationFrame","validateObject","complete","completion","loadingCompletion","completionStop","prompt","streamProtocol","streamObject","action","params","doc","currentInstructionId","options","actionParams","locale","code","streamText","body","generateUpload","fetch","JSON","stringify","credentials","headers","method","then","uploadResponse","ok","json","id","errors","errStr","map","message","join","catch","generate","includes"],"mappings":"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"}