{"version":3,"sources":["../../src/endpoints/index.ts"],"sourcesContent":["import type { PayloadRequest } from 'payload'\r\n\r\nimport type { ActionMenuItems, Endpoints, PluginConfig } from '../types.js'\r\n\r\nimport { defaultPrompts } from '../ai/prompts.js'\r\nimport {\r\n  PLUGIN_API_ENDPOINT_GENERATE,\r\n  PLUGIN_API_ENDPOINT_GENERATE_UPLOAD,\r\n  PLUGIN_INSTRUCTIONS_TABLE,\r\n  PLUGIN_NAME,\r\n} from '../defaults.js'\r\nimport { registerEditorHelper } from '../libraries/handlebars/helpers.js'\r\nimport { handlebarsHelpersMap } from '../libraries/handlebars/helpersMap.js'\r\nimport { replacePlaceholders } from '../libraries/handlebars/replacePlaceholders.js'\r\nimport { getGenerationModels } from '../utilities/getGenerationModels.js'\r\n\r\nconst assignPrompt = async (\r\n  action: ActionMenuItems,\r\n  {\r\n    type,\r\n    actionParams,\r\n    context,\r\n    field,\r\n    layout,\r\n    systemPrompt = '',\r\n    template,\r\n  }: {\r\n    actionParams: Record<any, any>\r\n    context: object\r\n    field: string\r\n    layout: string\r\n    systemPrompt: string\r\n    template: string\r\n    type: string\r\n  },\r\n) => {\r\n  const prompt = await replacePlaceholders(template, context)\r\n  const toLexicalHTML = type === 'richText' ? handlebarsHelpersMap.toHTML.name : ''\r\n\r\n  const assignedPrompts = {\r\n    layout: type === 'richText' ? layout : undefined,\r\n    prompt,\r\n    //TODO: Define only once on a collection level\r\n    system: type === 'richText' ? systemPrompt : undefined,\r\n  }\r\n\r\n  if (action === 'Compose') {\r\n    return assignedPrompts\r\n  }\r\n\r\n  const { layout: getLayout, system: getSystemPrompt } = defaultPrompts.find(\r\n    (p) => p.name === action,\r\n  )\r\n\r\n  let updatedLayout = layout\r\n  if (getLayout) {\r\n    updatedLayout = getLayout()\r\n  }\r\n\r\n  const system = getSystemPrompt({\r\n    ...(actionParams || {}),\r\n    prompt,\r\n    systemPrompt,\r\n  })\r\n\r\n  return {\r\n    layout: updatedLayout,\r\n    // TODO: revisit this toLexicalHTML\r\n    prompt: await replacePlaceholders(`{{${toLexicalHTML} ${field}}}`, context),\r\n    system,\r\n  }\r\n}\r\n\r\nexport const endpoints: (pluginConfig: PluginConfig) => Endpoints = (pluginConfig) =>\r\n  ({\r\n    textarea: {\r\n      //TODO:  This is the main endpoint for generating content - its just needs to be renamed to 'generate' or something.\r\n      handler: async (req: PayloadRequest) => {\r\n        const data = await req.json?.()\r\n\r\n        const { locale = 'en', options } = data\r\n        const { action, actionParams, instructionId } = options\r\n        const contextData = data.doc\r\n\r\n        if (!instructionId) {\r\n          throw new Error(\r\n            `Instruction ID is required for \"${PLUGIN_NAME}\" to work, please check your configuration`,\r\n          )\r\n        }\r\n\r\n        const instructions = await req.payload.findByID({\r\n          id: instructionId,\r\n          collection: PLUGIN_INSTRUCTIONS_TABLE,\r\n        })\r\n\r\n        const { collections } = req.payload.config\r\n        const collection = collections.find(\r\n          (collection) => collection.slug === PLUGIN_INSTRUCTIONS_TABLE,\r\n        )\r\n\r\n        const { custom: { [PLUGIN_NAME]: { editorConfig = {} } = {} } = {} } = collection.admin\r\n        const { schema: editorSchema = {} } = editorConfig\r\n        const { prompt: promptTemplate = '' } = instructions\r\n\r\n        const schemaPath = instructions['schema-path'] as string\r\n        const fieldName = schemaPath?.split('.').pop()\r\n\r\n        registerEditorHelper(req.payload, schemaPath)\r\n\r\n        const { defaultLocale, locales = [] } = req.payload.config.localization || {}\r\n        const localeData = locales.find((l) => {\r\n          return l.code === locale\r\n        })\r\n\r\n        const localeInfo = localeData?.label[defaultLocale] || locale\r\n\r\n        const model = getGenerationModels(pluginConfig)\r\n          .find((model) => model.id === instructions['model-id'])\r\n        const settingsName = model.settings?.name\r\n        const modelOptions = instructions[settingsName] || {}\r\n\r\n        const prompts = await assignPrompt(action, {\r\n          type: instructions['field-type'] as string,\r\n          actionParams,\r\n          context: contextData,\r\n          field: fieldName,\r\n          layout: instructions.layout,\r\n          systemPrompt: instructions.system,\r\n          template: promptTemplate as string,\r\n        })\r\n\r\n        prompts.prompt = `\r\n          ${prompts.prompt}\\n\\n\r\n          The locale the user is currently using is ${localeInfo}.\\n\\n\r\n        `\r\n\r\n        if(action === 'Translate'){\r\n          prompts.prompt = `\r\n            Translate the field of ${fieldName} to ${data.options.actionParams.locale}:\\n\\n${prompts.prompt}\\n\\n,\r\n            Make sure to output only the translation without any other text or explanation as you are not interacting with user.\\n\\n\r\n            here is the whole document with the field in it: ${JSON.stringify(data.doc)}\r\n          `\r\n        }\r\n\r\n        // console.log('Running handler with prompts:', prompts)\r\n        return model\r\n          .handler?.(prompts.prompt, {\r\n            ...modelOptions,\r\n            editorSchema,\r\n            layout: prompts.layout,\r\n            locale: localeInfo,\r\n            system: prompts.system,\r\n          })\r\n          .catch((error) => {\r\n            console.error('Error: endpoint - generating text:', error)\r\n            return new Response(JSON.stringify(error.message), { status: 500 })\r\n          })\r\n      },\r\n      method: 'post',\r\n      path: PLUGIN_API_ENDPOINT_GENERATE,\r\n    },\r\n    upload: {\r\n      handler: async (req: PayloadRequest) => {\r\n        const data = await req.json?.()\r\n\r\n        const { options } = data\r\n        const { instructionId } = options\r\n        const contextData = data.doc\r\n\r\n        let instructions = { 'model-id': '', prompt: '' }\r\n\r\n        if (instructionId) {\r\n          // @ts-expect-error\r\n          instructions = await req.payload.findByID({\r\n            id: instructionId,\r\n            collection: PLUGIN_INSTRUCTIONS_TABLE,\r\n          })\r\n        }\r\n\r\n        const { prompt: promptTemplate = '' } = instructions\r\n        const schemaPath = instructions['schema-path']\r\n\r\n        registerEditorHelper(req.payload, schemaPath)\r\n\r\n        const text = await replacePlaceholders(promptTemplate, contextData)\r\n        const modelId = instructions['model-id']\r\n        const uploadCollectionSlug = instructions['relation-to']\r\n\r\n        const model = getGenerationModels(pluginConfig)\r\n          .find((model) => model.id === modelId)\r\n        const settingsName = model.settings?.name\r\n        const modelOptions = instructions[settingsName] || {}\r\n\r\n        const result = await model.handler?.(text, modelOptions)\r\n\r\n        const assetData = await req.payload.create({\r\n          collection: uploadCollectionSlug,\r\n          data: result.data,\r\n          file: result.file,\r\n        })\r\n\r\n        return new Response(\r\n          JSON.stringify({\r\n            result: {\r\n              id: assetData.id,\r\n              alt: assetData.alt,\r\n            },\r\n          }),\r\n        )\r\n      },\r\n      method: 'post',\r\n      path: PLUGIN_API_ENDPOINT_GENERATE_UPLOAD,\r\n    },\r\n  }) satisfies Endpoints\r\n"],"names":["defaultPrompts","PLUGIN_API_ENDPOINT_GENERATE","PLUGIN_API_ENDPOINT_GENERATE_UPLOAD","PLUGIN_INSTRUCTIONS_TABLE","PLUGIN_NAME","registerEditorHelper","handlebarsHelpersMap","replacePlaceholders","getGenerationModels","assignPrompt","action","type","actionParams","context","field","layout","systemPrompt","template","prompt","toLexicalHTML","toHTML","name","assignedPrompts","undefined","system","getLayout","getSystemPrompt","find","p","updatedLayout","endpoints","pluginConfig","textarea","handler","req","data","json","locale","options","instructionId","contextData","doc","Error","instructions","payload","findByID","id","collection","collections","config","slug","custom","editorConfig","admin","schema","editorSchema","promptTemplate","schemaPath","fieldName","split","pop","defaultLocale","locales","localization","localeData","l","code","localeInfo","label","model","settingsName","settings","modelOptions","prompts","JSON","stringify","catch","error","console","Response","message","status","method","path","upload","text","modelId","uploadCollectionSlug","result","assetData","create","file","alt"],"mappings":"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"}